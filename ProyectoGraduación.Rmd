---
title: "Prueba proyecto graduación en R-Shiny"
author: "Ana Gabriela Álvarez Ruiz, Susana Meoño Piedra"
date: "2023-11-06"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(shiny)
library(dplyr)
library(ggplot2)
library(plotly)
library(leaflet)
library(readxl)
library(gt)
library(shinythemes)
library(shinycssloaders)

ui <- navbarPage(
  # Título de la app
  title = "Análisis inseguridad ciudadana",  
  
  # Crea tabPanels
  tabPanel(title = "Bienvenida", 
           
           p("El siguiente dashboard presentará un análisis de la seguridad ciudadana en Costa Rica.", br(),
                "Los datos son tomados de la página del Organismo Investigación Judicial, OIJ y tienen un fin educativo.", br(),
                "Este tablero es parte del proyecto final de graduación del técnico de Análisis y Visualización de datos.")
           ),            
  tabPanel(title = "Análisis General", 
           
           h1("Análisis General de la seguridad ciudadana en Costa Rica"),
           fluidRow(
             actionButton("show", "Cargar datos"),
             column(2,selectInput(inputId = "anyo", label = "Escoja el año", choices = NULL)),
             column(2, selectInput(inputId = "provincia",label = "Escoja la provincia:", choices = NULL)),
             column(2, selectInput(inputId = "delito",label = "Delito:", choices = NULL)),
             column(2,selectInput(inputId = "subdelito", label = "Subdelito", choices = NULL)),
             
             withSpinner(tableOutput("tabla1"), type = 3, color.background = "#060606", color = "#EEEEEE" )
           )
           ),  
  
  tabPanel(title = "Delitos por provincia", 
           h1("Análisis de Delitos por provincia"),
           h4("Se realizará una búsqueda de los cinco cantones con mayor cantidad de delitos por provincia"),
           fluidRow(
             column(12, selectInput(inputId = "prov", label = "Selecciona una provincia", choices = NULL))
           ),
           fluidRow(
             column(6, plotlyOutput("top_cantones")),
             column(6, leafletOutput("provincia_mapa"))
           )
           
           ), 
  
  # Crear un menu con subpaneles
  navbarMenu(title = "Departamentos",  
             
    tabPanel(title = "Financiero", 
             
             "aaa"
             ),    
    tabPanel(title = "Recursos Humanos", 
             
             "bbb"
             ), 
    
    tabPanel(title = "Analítica Avanzada", 
             
             "ccc"
             )     
  ),
  theme = shinythemes::shinytheme("darkly")
)

server <- function(input, output, session) {
  
  datos_policiales <- readxl::read_excel("datos/datos_oij.xlsx")
  coordenadas <- readr::read_csv("datos/Coordenadas por cantón.csv")
  
  observe({ 
    updateSelectInput(session, "anyo", choices = unique(datos_policiales$anyo))
    updateSelectInput(session, "provincia", choices = unique(datos_policiales$provincia))
    updateSelectInput(session, "prov", choices = unique(datos_policiales$provincia))
  })
  
  observeEvent(input$provincia, {
    
    opciones_delito <- datos_policiales |> 
      filter(provincia == input$provincia) |> 
      pull(delito) |> 
      unique()
  
    updateSelectInput(session, "delito", choices = opciones_delito)
  })
  
  observeEvent(input$delito, {
    
    opciones_subdelito <- datos_policiales |>
      filter(provincia == input$provincia, delito == input$delito) |>
      pull(sub_delito) |>
      unique()
    
    updateSelectInput(session, "subdelito", choices = opciones_subdelito)
  })

  
   output$tabla1 <- renderTable({
    req(input$show, input$anyo, input$provincia, input$delito, input$subdelito)
    
    datos_filtrados <- datos_policiales |> 
      filter(anyo == input$anyo, 
             provincia == input$provincia, 
             delito == input$delito, 
             sub_delito == input$subdelito) 
    
    tabla_filtro <- datos_filtrados |> 
      group_by(provincia) |> 
      summarise(Total_delitos = sum(delito),
                Total_subdelito = sum(sub_delito))
    
    tabla_filtro
  })
  
  
  datos_provincia <- reactive({
    datos_policiales |> 
      filter(provincia == input$prov)
  })
  
  output$top_cantones <- renderPlotly({
    grafico<- datos_provincia() |> 
      group_by(canton) |> 
      summarise(Total = n()) |> 
      arrange(desc(Total)) |> 
      head(5) |> 
      ggplot(aes(reorder(canton,-Total), y= Total))+
      geom_bar(stat = "identity")+
      labs(title = "Cinco cantones con mayor cantidad de delitos",
           x="Cantón", y = "Cantidad de delitos")
    
    grafico
    ggplotly(grafico)
  })
  
  output$provincia_mapa <- renderLeaflet({
    if (!is.null(input$prov)) {
      provincia_seleccionada <- coordenadas |> 
        filter(Provincia == input$prov)
      
      mi_mapa <- leaflet() |> 
        addTiles() |> 
        addMarkers(data = provincia_seleccionada,
                   lng = ~as.numeric(Longitud),
                   lat = ~as.numeric(Latitud),
                   popup = ~as.numeric(Provincia))
      
      mi_mapa
    }
  })
  
}

shinyApp(ui, server)

```